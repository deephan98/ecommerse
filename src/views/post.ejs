<!DOCTYPE html>
<%
  var posts = typeof posts !== 'undefined' ? posts : [];
%>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create/Update Product Post</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/animation.css">
  <style>
    .summary-card {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .summary-card h2 {
      margin-bottom: 10px;
    }
    .summary-card .summary-row {
      margin-bottom: 8px;
    }
    .media-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
      margin-top: 10px;
    }
    .media-item img, .media-item video {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 4px;
    }
    .media-item {
      position: relative;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
      background: #fff;
    }
    .no-media {
      color: #888;
      font-style: italic;
      margin: 10px 0;
    }
    .post-list {
      margin-top: 40px;
    }
    .post-card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.07);
      margin-bottom: 30px;
      padding: 20px;
      transition: box-shadow 0.2s;
    }
    .post-card:hover {
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
    .post-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .post-price {
      color: #28a745;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .post-description {
      margin-bottom: 10px;
      color: #555;
    }
    .post-media {
      margin-top: 10px;
    }
    .post-media .media-preview {
      margin-top: 0;
    }
    .post-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .edit-btn {
      background-color: #007bff;
      color: white;
    }
    .set-home-btn {
      background-color: #28a745;
      color: white;
    }
    .set-home-btn.active {
      background-color: #218838;
      box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="animate-fade-in">
      <h1 class="animate-slide-left">Create a New Product Post</h1>
      <nav class="animate-slide-right">
        <a href="/" class="hover-grow">Home</a>
        <a href="/admin" class="hover-grow">Admin</a>
        <a href="/products" class="hover-grow">All Products</a>
      </nav>
    </header>
    <main>
      <section class="admin-panel reveal">
        <h2 class="animate-slide-up">Post a Product</h2>
        <p>Fill in the details and upload images/videos for your product. All fields are required.</p>
        <form action="/post" method="POST" enctype="multipart/form-data" id="postForm">
          <div class="form-group">
            <label for="name">Product Name:</label>
            <input type="text" id="name" name="name" required>
          </div>
          <div class="form-group">
            <label for="price">Price ($):</label>
            <input type="number" id="price" name="price" step="0.01" min="0" required>
          </div>
          <div class="form-group">
            <label for="description">Description:</label>
            <textarea id="description" name="description" rows="4" required></textarea>
          </div>
          <div class="form-group">
            <label for="productImages">Product Images (Multiple):</label>
            <input type="file" id="productImages" name="productImages" accept="image/*" multiple>
          </div>
          <div class="form-group">
            <label for="productVideos">Product Videos (Multiple):</label>
            <input type="file" id="productVideos" name="productVideos" accept="video/*" multiple>
          </div>
          <button type="submit" class="btn hover-grow animate-pulse">Save Post</button>
        </form>
      </section>
      <section class="post-list">
        <h2>All Product Posts</h2>
        <% if (posts && posts.length > 0) { %>
          <% posts.slice().reverse().forEach(function(post, idx) { %>
            <div class="post-card animate-fade-in" style="animation-delay: <%= idx * 0.05 %>s">
              <div class="post-title"><%= post.name %></div>
              <div class="post-price">$<%= (typeof post.price === 'number' ? post.price.toFixed(2) : post.price) %></div>
              <div class="post-description"><%= post.description %></div>
              <div class="post-media">
                <div class="media-preview">
                  <% if (post.images && post.images.length > 0) { %>
                    <% post.images.forEach(function(image) { %>
                      <div class="media-item"><img src="<%= image %>" alt="<%= post.name %> image"></div>
                    <% }); %>
                  <% } else { %>
                    <div class="no-media">No images</div>
                  <% } %>
                  <% if (post.videos && post.videos.length > 0) { %>
                    <% post.videos.forEach(function(video) { %>
                      <div class="media-item"><video src="<%= video %>" controls></video></div>
                    <% }); %>
                  <% } else { %>
                    <div class="no-media">No videos</div>
                  <% } %>
                </div>
              </div>
              <div class="post-actions">
                <a href="/post/edit/<%= post.id %>" class="btn edit-btn hover-grow">Edit Post</a>
                <button class="btn set-home-btn hover-grow" data-id="<%= post.id %>">Set as Home Product</button>
              </div>
            </div>
          <% }); %>
        <% } else { %>
          <div class="no-media">No posts yet. Use the form above to create your first product post!</div>
        <% } %>
      </section>
    </main>
    <footer class="animate-fade-in">
      <p>&copy; <%= new Date().getFullYear() %> Simple E-commerce</p>
    </footer>
  </div>
  
  <script>
    // Preview uploaded images
    document.getElementById('productImages').addEventListener('change', function(e) {
      const preview = document.getElementById('imagePreview');
      if (!preview) return;
      
      preview.innerHTML = '';
      
      if (this.files) {
        Array.from(this.files).forEach(file => {
          const reader = new FileReader();
          reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'media-item';
            div.innerHTML = `<img src="${e.target.result}" alt="Image preview">`;
            preview.appendChild(div);
          }
          reader.readAsDataURL(file);
        });
      }
    });
    
    // Preview uploaded videos
    document.getElementById('productVideos').addEventListener('change', function(e) {
      const preview = document.getElementById('videoPreview');
      if (!preview) return;
      
      preview.innerHTML = '';
      
      if (this.files) {
        Array.from(this.files).forEach(file => {
          const reader = new FileReader();
          reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'media-item';
            div.innerHTML = `<video src="${e.target.result}" controls></video>`;
            preview.appendChild(div);
          }
          reader.readAsDataURL(file);
        });
      }
    });
    
    // Set as Home Product buttons
    document.querySelectorAll('.set-home-btn').forEach(button => {
      button.addEventListener('click', function() {
        const postId = this.getAttribute('data-id');
        
        fetch('/post/set-home', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            postId: postId
          }),
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('This product is now set as the home page product!');
            
            // Update all buttons to show which one is active
            document.querySelectorAll('.set-home-btn').forEach(btn => {
              btn.textContent = 'Set as Home Product';
              btn.classList.remove('active');
            });
            
            this.textContent = 'âœ“ Home Product';
            this.classList.add('active');
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
      });
    });
  </script>
</body>
</html>